services:
  # ============================================
  # Development container with workspace volume
  # ============================================
  ros2-dev:
    build:
      context: .
      target: dev
      dockerfile: Dockerfile
    image: ros2-workspace:dev
    container_name: ros2-dev
    stdin_open: true
    tty: true
    network_mode: host
    volumes:
      - .:/ws
      - ccache:/root/.ccache
    command: bash -c "source /opt/ros/humble/setup.bash && if [ -f /ws/install/setup.bash ]; then source /ws/install/setup.bash; fi && bash"
    environment:
      - DISPLAY=host.docker.internal:0.0
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - CYCLONEDDS_URI=file:///etc/cyclonedds.xml
      # Для GUI приложений (RViz, Gazebo)
      - QT_X11_NO_MITSHM=1
    # Для X11 forwarding
    # volumes:
    #   - /tmp/.X11-unix:/tmp/.X11-unix:rw

  # ============================================
  # Talker node (demo)
  # ============================================
  talker:
    image: ros:humble-ros-base
    container_name: ros2-talker
    network_mode: host
    command: bash -c "apt-get update && apt-get install -y ros-humble-demo-nodes-cpp && source /opt/ros/humble/setup.bash && ros2 run demo_nodes_cpp talker"
    environment:
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp

  # ============================================
  # Listener node (demo)
  # ============================================
  listener:
    image: ros:humble-ros-base
    container_name: ros2-listener
    network_mode: host
    command: bash -c "apt-get update && apt-get install -y ros-humble-demo-nodes-cpp && source /opt/ros/humble/setup.bash && ros2 run demo_nodes_cpp listener"
    environment:
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp

  # ============================================
  # Runtime container (production)
  # ============================================
  ros2-runtime:
    build:
      context: .
      target: runtime
      dockerfile: Dockerfile
    image: ros2-workspace:runtime
    container_name: ros2-runtime
    network_mode: host
    stdin_open: true
    tty: true
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - CYCLONEDDS_URI=file:///etc/cyclonedds.xml

volumes:
  ccache:
    driver: local

# ============================================
# Для Windows/Mac: bridge network config
# ============================================
# networks:
#   ros2_net:
#     driver: bridge
#     ipam:
#       config:
#         - subnet: 172.20.0.0/16
