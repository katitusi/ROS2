# Техническое задание: ROS 2 пакет `rebel_dance_demo`

## Контекст
Вы работаете внутри Docker dev-контейнера с ROS 2 Humble + MoveIt2.

Рабочая область находится в `/ws` и уже собрана с помощью `colcon`.
Робот igus ReBeL доступен через пакеты `iRC_ROS` и конфигурацию MoveIt2:

- URDF + ros2_control загружаются из `irc_ros_description`
- Конфигурация MoveIt2: `irc_ros_moveit_config`
- Имя робота: `igus_rebel_6dof`
- Имя MoveIt группы: `rebel_6dof`
- Звено эффектора: `tcp`

## Предположение
Отдельный процесс уже запускает стек робота (симуляция или реальный робот), например:

- **Симуляция:**
  ```bash
  ros2 launch irc_ros_moveit_config rebel.launch.py hardware_protocol:=mock_hardware
  ```

- **Реальный робот:**
  ```bash
  ros2 launch irc_ros_bringup rebel.launch.py hardware_protocol:=cprcanv2
  ```

## Задача
Создать ROS 2 Python пакет `rebel_dance_demo`, который реализует 30-секундный танец для робота ReBeL с хореографией, вдохновленной танцами роботов Boston Dynamics и других промышленных манипуляторов.

---

## Архитектура

### 1) Хореографический движок
- **Имя ноды:** `rebel_dancer`
- **Файл:** `rebel_dance_demo/rebel_dancer.py`
- **Использует:** `rclpy` + `moveit_commander` (MoveIt2 Python интерфейс)
- **Создает:** `MoveGroupCommander` для группы `rebel_6dof`
- **Конфигурация:**
  - `set_max_velocity_scaling_factor(0.3)` (30% скорости для плавности)
  - `set_max_acceleration_scaling_factor(0.3)` (30% ускорения)

### 2) Танцевальная хореография (30 секунд)

Вдохновлено танцами роботов и создано специально для 6-DOF манипулятора.

**Структура танца:**

1. **Opening Pose (0-2 сек)** - Приветствие
   - Начальная поза: все суставы в нейтральном положении
   - Плавный подъем "руки" вверх (как взмах приветствия)

2. **Wave Motion (2-8 сек)** - Волновые движения
   - Синусоидальные движения через все суставы
   - Создает эффект "волны" от основания к кончику
   - 3 полных цикла волны

3. **Figure-8 Pattern (8-14 сек)** - Восьмёрка в пространстве
   - Эффектор рисует восьмерку в воздухе
   - Использует планирование в декартовом пространстве
   - 2 полных цикла восьмерки

4. **Robot Twist (14-20 сек)** - Скручивание
   - Последовательное вращение каждого сустава
   - Создает эффект "скручивания" робота
   - Поочередное движение суставов 1, 4, 6

5. **Grand Finale (20-28 сек)** - Быстрая комбинация
   - Серия быстрых переходов между ключевыми позами
   - 5 динамичных поз с быстрой сменой
   - Увеличенная скорость до 50%

6. **Bow (28-30 сек)** - Поклон
   - Возврат в нейтральную позу
   - Небольшой наклон "вперед" (поклон)
   - Возврат в исходное положение

### 3) Определенные позы

Жестко заданные массивы из 6 значений углов сочленений (в радианах):

```python
# Нейтральная поза
neutral = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

# Приветствие (рука вверх)
greeting = [0.0, -0.8, 1.2, 0.0, 0.5, 0.0]

# Волновые позы
wave_1 = [0.3, -0.3, 0.6, 0.2, 0.4, 0.5]
wave_2 = [-0.3, -0.5, 0.8, -0.2, 0.3, -0.5]
wave_3 = [0.0, -0.4, 0.7, 0.0, 0.35, 0.0]

# Скручивание
twist_1 = [1.0, -0.4, 0.7, 0.0, 0.3, 0.0]
twist_2 = [1.0, -0.4, 0.7, 1.2, 0.3, 0.0]
twist_3 = [1.0, -0.4, 0.7, 1.2, 0.3, 1.5]

# Финальные позы
finale_1 = [0.5, -0.9, 1.3, 0.8, 0.6, 1.0]
finale_2 = [-0.5, -0.3, 0.4, -0.8, 0.2, -1.0]
finale_3 = [0.8, -0.7, 1.0, 0.5, 0.8, 0.5]
finale_4 = [-0.8, -0.5, 0.8, -0.5, 0.4, -0.5]
finale_5 = [0.0, -0.6, 0.9, 0.0, 0.5, 0.0]

# Поклон
bow = [0.0, 0.3, -0.3, 0.0, -0.2, 0.0]
```

### 4) Реализация ноды

**Функционал:**
- Метод `perform_dance()`: выполняет полную последовательность танца
- Метод `move_to_pose(joint_values, velocity_scale)`: двигается к заданной позе с указанной скоростью
- Метод `interpolate_wave()`: создает плавные волновые движения с интерполяцией
- Метод `draw_figure_eight()`: рисует восьмерку в декартовом пространстве
- ROS 2 сервис `/rebel_dance_demo/start_dance` (std_srvs/Trigger): запускает танец по команде

**Логирование:**
- Прогресс танца с временными метками
- Текущая фаза танца
- Успешность выполнения каждого движения

### 5) Launch файлы

#### `launch/dance_demo_sim.launch.py`
Запускает:
- `rebel_dancer`

Цель: симуляция (mock hardware уже запущен в другом терминале)

#### `launch/dance_demo_real.launch.py`
- Та же нода
- Добавить заметное предупреждение в логе при запуске
- Скорость уменьшена до 20% для безопасности на реальном роботе

### 6) Структура пакета

Создать в `/ws/src/rebel_dance_demo`:

```
rebel_dance_demo/
├── package.xml
├── setup.py
├── setup.cfg
├── resource/
│   └── rebel_dance_demo
├── rebel_dance_demo/
│   ├── __init__.py
│   └── rebel_dancer.py
└── launch/
    ├── dance_demo_sim.launch.py
    └── dance_demo_real.launch.py
```

Тип сборки: `ament_python`

### 7) Зависимости

В `package.xml` и `setup.py` добавить runtime зависимости:
- `rclpy`
- `std_srvs`
- `moveit_commander`
- `moveit_ros_planning_interface`
- `geometry_msgs`

### 8) Entry points

В `setup.py` добавить console script:
```python
'console_scripts': [
    'rebel_dancer = rebel_dance_demo.rebel_dancer:main',
],
```

---

## Особенности танца

1. **Плавность:** Все движения должны быть плавными, без резких рывков
2. **Синхронизация:** Движения синхронизированы с временными интервалами
3. **Безопасность:** Все позы должны быть достижимы в рабочем пространстве робота
4. **Зрелищность:** Комбинация медленных плавных и быстрых динамичных движений
5. **Повторяемость:** Танец должен выполняться одинаково каждый раз

## Результат

После выполнения задания покажите полное содержимое:
- `rebel_dance_demo/rebel_dancer.py`
- `launch/dance_demo_sim.launch.py`
- Соответствующие части:
  - `setup.py` (entry_points)
  - `package.xml` (dependencies)

---

## Шаги запуска

После создания пакета:

```bash
cd /ws
colcon build --packages-select rebel_dance_demo
source install/setup.bash

# Симуляция ReBeL уже запущена в другом терминале
ros2 launch rebel_dance_demo dance_demo_sim.launch.py

# Или запустить танец вручную через сервис:
ros2 service call /rebel_dance_demo/start_dance std_srvs/srv/Trigger
```

## Визуализация

Для наблюдения за танцем рекомендуется использовать:
- RViz с MoveIt motion planning plugin
- Или Foxglove Studio через rosbridge

## Дополнительные фичи (опционально)

- Добавить топик `/dance_progress` для отслеживания прогресса
- Возможность паузы/возобновления через сервис
- Параметр для выбора скорости танца (slow/normal/fast)
- Музыкальное сопровождение через audio топик
